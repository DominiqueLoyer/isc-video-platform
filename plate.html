<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plateforme de diffusion de l'institut des sciences cognitives</title>
    <meta name="description"
        content="Plateforme de diffusion vidéo de l'Institut des Sciences Cognitives de l'UQAM. Explorez des conférences, cours et présentations sur la cognition, l'IA, les neurosciences et la philosophie de l'esprit.">
    <meta name="keywords" content="ISC, UQAM, sciences cognitives, neurosciences, IA, philosophie, conférences, vidéos">
    <meta property="og:title" content="Plateforme ISC - Institut des Sciences Cognitives UQAM">
    <meta property="og:description"
        content="Explorez des vidéos sur les sciences cognitives, l'IA et les neurosciences.">
    <meta property="og:type" content="website">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --uqam-dark-blue: #003366;
            --uqam-light-blue: #337ab7;
            --uqam-grey: #f5f5f5;
            --uqam-dark-grey: #cccccc;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--uqam-grey);
        }

        .header-bg {
            background: linear-gradient(135deg, var(--uqam-dark-blue) 0%, #004488 100%);
        }

        .button-primary {
            background-color: var(--uqam-light-blue);
            color: white;
            transition: all 0.3s ease;
        }

        .button-primary:hover {
            background-color: #286090;
            transform: translateY(-1px);
        }

        .button-secondary {
            background-color: var(--uqam-dark-grey);
            color: var(--uqam-dark-blue);
            transition: all 0.3s ease;
        }

        .button-secondary:hover {
            background-color: #b3b3b3;
        }

        .video-card {
            background-color: white;
            border: 1px solid #e0e0e0;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
            cursor: pointer;
        }

        .search-input {
            border: 2px solid var(--uqam-dark-blue);
        }

        .search-input:focus {
            border-color: var(--uqam-light-blue);
            box-shadow: 0 0 0 3px rgba(51, 122, 183, 0.25);
            outline: none;
        }

        .video-player-container {
            background-color: black;
        }

        .video-info {
            background-color: white;
        }

        /* Boutons de partage */
        .share-button {
            padding: 10px 16px;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .share-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .share-facebook {
            background-color: #1877F2;
            color: white;
        }

        .share-twitter {
            background-color: #1DA1F2;
            color: white;
        }

        .share-linkedin {
            background-color: #0A66C2;
            color: white;
        }

        .share-whatsapp {
            background-color: #25D366;
            color: white;
        }

        .share-telegram {
            background-color: #0088cc;
            color: white;
        }

        .share-email {
            background-color: #6c757d;
            color: white;
        }

        .share-copy {
            background-color: var(--uqam-dark-blue);
            color: white;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            padding: 28px;
            border-radius: 12px;
            text-align: left;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 550px;
            transform: scale(0.9);
            transition: all 0.3s ease;
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        .modal-content h3 {
            color: var(--uqam-dark-blue);
            margin-bottom: 20px;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .modal-content label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 0.875rem;
        }

        .modal-content input[type="text"],
        .modal-content input[type="password"],
        .modal-content textarea,
        .modal-content select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.95rem;
            transition: border-color 0.2s ease;
        }

        .modal-content input:focus,
        .modal-content textarea:focus,
        .modal-content select:focus {
            border-color: var(--uqam-light-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(51, 122, 183, 0.15);
        }

        .modal-content textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-content input:disabled,
        .modal-content textarea:disabled {
            background-color: #f9f9f9;
            cursor: not-allowed;
        }

        /* Tags de mots-clés */
        .keyword-tag {
            background-color: #e8f4fc;
            color: var(--uqam-dark-blue);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 4px;
            margin-bottom: 4px;
            display: inline-block;
        }

        .keyword-tag-detail {
            background-color: var(--uqam-light-blue);
            color: white;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-right: 8px;
            margin-bottom: 8px;
            display: inline-block;
        }

        /* Container miniature */
        .video-thumbnail-container {
            width: 100%;
            height: 12rem;
            background-color: #e0e0e0;
            position: relative;
            overflow: hidden;
        }

        .video-thumbnail-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .video-card:hover .video-thumbnail-container img {
            transform: scale(1.05);
        }

        /* Indicateur de thème */
        .theme-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--uqam-light-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 14px 24px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            background-color: #10B981;
        }

        .toast-error {
            background-color: #EF4444;
        }

        .toast-info {
            background-color: var(--uqam-light-blue);
        }

        /* Formatage des nombres de vues */
        .view-count {
            color: #666;
            font-size: 0.875rem;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <header class="header-bg text-white p-4 shadow-lg">
        <div class="container mx-auto flex flex-wrap items-center justify-between">
            <a href="#" onclick="showHomePage(); return false;"
                class="text-xl sm:text-2xl font-bold hover:opacity-90 transition-opacity">
                <i class="fas fa-brain mr-2"></i>Plateforme de diffusion ISC
            </a>

            <div
                class="w-full md:w-auto mt-4 md:mt-0 flex flex-col md:flex-row items-center md:ml-auto space-y-2 md:space-y-0 md:space-x-2">
                <!-- Recherche -->
                <div class="relative w-full md:w-auto">
                    <input type="search" id="searchInput"
                        class="search-input w-full md:w-64 lg:w-80 p-2 pl-10 rounded-md text-gray-800 focus:outline-none"
                        placeholder="Rechercher...">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"><i
                            class="fas fa-search"></i></span>
                </div>

                <!-- Filtre par mot-clé -->
                <div class="relative w-full md:w-auto">
                    <select id="keywordFilter"
                        class="search-input w-full md:w-48 p-2 pr-10 rounded-md text-gray-800 focus:outline-none appearance-none">
                        <option value="">Tous les mots-clés</option>
                    </select>
                    <span
                        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"><i
                            class="fas fa-chevron-down"></i></span>
                </div>

                <!-- Filtre par thème -->
                <div class="relative w-full md:w-auto">
                    <select id="themeFilter"
                        class="search-input w-full md:w-48 p-2 pr-10 rounded-md text-gray-800 focus:outline-none appearance-none">
                        <option value="">Tous les thèmes</option>
                    </select>
                    <span
                        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"><i
                            class="fas fa-chevron-down"></i></span>
                </div>

                <!-- Section Admin -->
                <div id="adminControlsContainer"
                    class="flex flex-col md:flex-row items-center space-y-2 md:space-y-0 md:space-x-2 w-full md:w-auto">
                    <button id="adminLoginButton"
                        class="button-secondary font-semibold py-2 px-4 rounded-md w-full md:w-auto">
                        <i class="fas fa-lock mr-1"></i>Accès Admin
                    </button>
                    <button id="addYoutubeVideoBtn"
                        class="button-primary font-semibold py-2 px-4 rounded-md w-full md:w-auto hidden">
                        <i class="fab fa-youtube mr-2"></i>Ajouter Vidéo
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main id="mainContent" class="container mx-auto p-4">
        <!-- Page grille de vidéos -->
        <section id="videoGridPage">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-700">
                    <i class="fas fa-play-circle mr-2 text-[var(--uqam-light-blue)]"></i>Vidéos disponibles
                </h2>
                <span id="videoCount" class="text-gray-500"></span>
            </div>

            <!-- Loader -->
            <div id="gridLoader" class="text-center py-12 hidden">
                <div class="loading-spinner mx-auto mb-4" style="width: 40px; height: 40px;"></div>
                <p class="text-gray-500">Chargement des vidéos...</p>
            </div>

            <div id="videoGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Les cartes de vidéos seront insérées ici par JS -->
            </div>

            <div class="text-center mt-8">
                <button id="viewMoreButton" class="button-primary font-semibold py-2 px-6 rounded-md hidden">
                    Voir Toutes les Vidéos
                </button>
            </div>
        </section>

        <!-- Page détail vidéo -->
        <section id="videoPlayerPage" class="hidden">
            <div class="max-w-4xl mx-auto">
                <button onclick="showHomePage(); return false;" class="button-primary mb-4 py-2 px-4 rounded-md">
                    <i class="fas fa-arrow-left mr-2"></i>Retour
                </button>

                <!-- Lecteur Vidéo (iframe YouTube) -->
                <div class="video-player-container rounded-lg shadow-xl overflow-hidden">
                    <iframe id="mainVideoPlayerIframe" width="100%" class="aspect-video" src="" title="Lecteur vidéo"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                </div>

                <!-- Informations sur la vidéo -->
                <div class="video-info p-6 mt-4 rounded-lg shadow-lg">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h2 id="videoTitleElem" class="text-2xl md:text-3xl font-bold text-gray-800"></h2>
                            <div class="flex flex-wrap items-center gap-3 mt-2 text-gray-600">
                                <span id="videoUploader"><i class="fas fa-user mr-1"></i><span
                                        class="font-semibold"></span></span>
                                <span id="videoViews"><i class="fas fa-eye mr-1"></i><span
                                        class="font-semibold"></span></span>
                                <span id="videoTheme"
                                    class="px-3 py-1 rounded-full text-sm font-semibold text-white"></span>
                            </div>
                        </div>
                        <!-- Boutons Admin (visible seulement si admin) -->
                        <div id="videoDetailAdminBtns" class="hidden flex-shrink-0 space-x-2">
                            <button id="editCurrentVideoBtn" class="button-secondary py-2 px-3 rounded-md text-sm">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button id="deleteCurrentVideoBtn"
                                class="bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-md text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Résumé IA -->
                    <div class="mb-6">
                        <h3
                            class="text-xl font-bold mb-3 text-[var(--uqam-dark-blue)] border-b-2 border-[var(--uqam-light-blue)] pb-1">
                            <i class="fas fa-robot mr-2"></i>Résumé (généré par IA)
                        </h3>
                        <p id="videoAiSummary" class="text-gray-700 whitespace-pre-line leading-relaxed"></p>
                    </div>

                    <!-- Mots-clés -->
                    <div class="mb-6">
                        <h3
                            class="text-xl font-bold mb-3 text-[var(--uqam-dark-blue)] border-b-2 border-[var(--uqam-light-blue)] pb-1">
                            <i class="fas fa-tags mr-2"></i>Mots-clés
                        </h3>
                        <div id="videoKeywordsContainer" class="flex flex-wrap"></div>
                    </div>

                    <!-- Annotation Admin -->
                    <div class="mb-6">
                        <h3
                            class="text-xl font-bold mb-3 text-[var(--uqam-dark-blue)] border-b-2 border-[var(--uqam-light-blue)] pb-1">
                            <i class="fas fa-comment-dots mr-2"></i>Annotation de l'administrateur
                        </h3>
                        <p id="videoAdminAnnotation"
                            class="text-gray-700 whitespace-pre-line bg-blue-50 p-4 border-l-4 border-blue-400 rounded-r-md">
                        </p>
                    </div>

                    <!-- Description Originale -->
                    <details class="mb-6">
                        <summary class="cursor-pointer text-gray-600 hover:text-black font-medium">
                            <i class="fab fa-youtube mr-1"></i>Voir la description YouTube originale
                        </summary>
                        <p id="videoOriginalDescription"
                            class="text-gray-600 mt-2 p-3 bg-gray-50 border rounded-md whitespace-pre-line"></p>
                    </details>

                    <!-- Boutons de Partage Étendus -->
                    <div class="share-buttons border-t pt-5">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700">
                            <i class="fas fa-share-alt mr-2"></i>Partager cette vidéo
                        </h3>
                        <div class="flex flex-wrap gap-2">
                            <a href="#" id="shareFacebook" target="_blank" class="share-button share-facebook">
                                <i class="fab fa-facebook-f"></i> Facebook
                            </a>
                            <a href="#" id="shareTwitter" target="_blank" class="share-button share-twitter">
                                <i class="fab fa-x-twitter"></i> X (Twitter)
                            </a>
                            <a href="#" id="shareLinkedIn" target="_blank" class="share-button share-linkedin">
                                <i class="fab fa-linkedin-in"></i> LinkedIn
                            </a>
                            <a href="#" id="shareWhatsApp" target="_blank" class="share-button share-whatsapp">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </a>
                            <a href="#" id="shareTelegram" target="_blank" class="share-button share-telegram">
                                <i class="fab fa-telegram-plane"></i> Telegram
                            </a>
                            <a href="#" id="shareEmail" class="share-button share-email">
                                <i class="fas fa-envelope"></i> Email
                            </a>
                            <button id="copyLinkButton" class="share-button share-copy">
                                <i class="fas fa-link"></i> Copier le lien
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="text-center p-4 mt-8 text-gray-600 border-t border-gray-300 bg-white">
        <p>© 2025 Institut des Sciences Cognitives - UQAM</p>
        <p class="text-sm mt-1">Développement par l'équipe ISC</p>
    </footer>

    <!-- Modal de connexion Admin -->
    <div id="adminLoginModal" class="modal-overlay">
        <div class="modal-content">
            <h3><i class="fas fa-lock mr-2"></i>Accès Administrateur</h3>
            <label for="adminPassword">Mot de passe :</label>
            <input type="password" id="adminPassword" placeholder="Entrez le mot de passe admin">
            <div class="flex justify-end space-x-2 mt-4">
                <button id="closeAdminLoginModal" class="button-secondary py-2 px-4 rounded-md">Annuler</button>
                <button id="submitAdminLogin" class="button-primary py-2 px-4 rounded-md">
                    <i class="fas fa-sign-in-alt mr-1"></i>Se Connecter
                </button>
            </div>
        </div>
    </div>

    <!-- Modal pour Ajouter/Modifier une vidéo YouTube -->
    <div id="addYoutubeVideoModal" class="modal-overlay">
        <div class="modal-content max-h-[90vh] overflow-y-auto">
            <h3 id="videoModalTitle"><i class="fab fa-youtube mr-2"></i>Ajouter une Vidéo YouTube</h3>

            <label for="youtubeVideoUrl">URL de la vidéo YouTube :</label>
            <input type="text" id="youtubeVideoUrl" placeholder="https://www.youtube.com/watch?v=VIDEO_ID">
            <button id="fetchYoutubeInfoBtn" class="button-secondary py-2 px-4 rounded-md mb-3 w-full">
                <i class="fas fa-download mr-2"></i>Récupérer Infos YouTube
            </button>

            <!-- Aperçu des informations récupérées -->
            <div id="youtubeInfoPreview" class="mb-3 hidden border p-4 rounded-md bg-gray-50">
                <h4 class="font-semibold text-lg text-[var(--uqam-dark-blue)] mb-3">
                    <i class="fas fa-info-circle mr-1"></i>Informations Récupérées
                </h4>
                <img id="previewThumbnail" src="" alt="Miniature" class="w-40 h-auto my-2 rounded shadow">

                <label for="previewTitle">Titre :</label>
                <input type="text" id="previewTitle" placeholder="Titre de la vidéo">

                <label for="previewChannel">Chaîne :</label>
                <input type="text" id="previewChannel" placeholder="Nom de la chaîne">

                <label for="previewAiSummary">Résumé :</label>
                <textarea id="previewAiSummary" rows="3" placeholder="Résumé de la vidéo..."></textarea>

                <label for="previewKeywords">Mots-clés (séparés par virgule) :</label>
                <input type="text" id="previewKeywords" placeholder="IA, Cognition, Neurosciences">

                <label for="previewTheme">Thématique :</label>
                <select id="previewTheme">
                    <option value="">-- Sélectionner --</option>
                </select>
            </div>

            <!-- Annotation personnelle admin -->
            <label for="adminCustomDescription">Annotation personnelle (visible sur la page de détail) :</label>
            <textarea id="adminCustomDescription"
                placeholder="Ajoutez votre analyse, notes ou commentaires..."></textarea>

            <input type="hidden" id="editingVideoId">

            <div class="flex justify-end space-x-2 mt-4">
                <button id="closeAddYoutubeVideoModal" class="button-secondary py-2 px-4 rounded-md">Annuler</button>
                <button id="saveYoutubeVideoBtn" class="button-primary py-2 px-4 rounded-md">
                    <i class="fas fa-save mr-1"></i>Sauvegarder
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation de suppression -->
    <div id="deleteConfirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Confirmer la suppression</h3>
            <p class="text-gray-700 mb-4">Êtes-vous sûr de vouloir supprimer cette vidéo ? Cette action est
                irréversible.</p>
            <div class="flex justify-end space-x-2 mt-4">
                <button id="cancelDeleteBtn" class="button-secondary py-2 px-4 rounded-md">Annuler</button>
                <button id="confirmDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-md">
                    <i class="fas fa-trash mr-1"></i>Supprimer
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================

        // URL de l'API backend (changer selon l'environnement)
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? '' // En local, utilise le même serveur
            : 'https://isc-video-platform.onrender.com'; // En production

        // ============================================
        // ÉTAT GLOBAL
        // ============================================

        let isAdmin = false;
        let adminToken = null;
        let currentVideos = [];
        let themes = [];
        let currentVideoId = null;
        const initialDisplayCount = 6;
        let showingAllVideos = false;

        // ============================================
        // ÉLÉMENTS DOM
        // ============================================

        const videoGrid = document.getElementById('videoGrid');
        const gridLoader = document.getElementById('gridLoader');
        const searchInput = document.getElementById('searchInput');
        const keywordFilter = document.getElementById('keywordFilter');
        const themeFilter = document.getElementById('themeFilter');
        const videoGridPage = document.getElementById('videoGridPage');
        const videoPlayerPage = document.getElementById('videoPlayerPage');
        const mainVideoPlayerIframe = document.getElementById('mainVideoPlayerIframe');
        const videoTitleElem = document.getElementById('videoTitleElem');
        const videoUploaderElem = document.getElementById('videoUploader').querySelector('span');
        const videoViewsElem = document.getElementById('videoViews').querySelector('span');
        const videoThemeElem = document.getElementById('videoTheme');
        const videoAiSummaryElem = document.getElementById('videoAiSummary');
        const videoKeywordsContainerElem = document.getElementById('videoKeywordsContainer');
        const videoAdminAnnotationElem = document.getElementById('videoAdminAnnotation');
        const videoOriginalDescriptionElem = document.getElementById('videoOriginalDescription');
        const videoDetailAdminBtns = document.getElementById('videoDetailAdminBtns');
        const adminLoginButton = document.getElementById('adminLoginButton');
        const addYoutubeVideoBtn = document.getElementById('addYoutubeVideoBtn');
        const viewMoreButton = document.getElementById('viewMoreButton');
        const videoCountElem = document.getElementById('videoCount');

        // ============================================
        // UTILITAIRES
        // ============================================

        function showModal(modalElement) {
            modalElement.classList.add('show');
        }

        function hideModal(modalElement) {
            modalElement.classList.remove('show');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle'} mr-2"></i>${message}`;
            container.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        }

        function formatViews(views) {
            if (!views || views === 0) return 'N/A';
            if (views >= 1000000) return (views / 1000000).toFixed(1) + 'M vues';
            if (views >= 1000) return (views / 1000).toFixed(0) + 'K vues';
            return views + ' vues';
        }

        function getYouTubeVideoId(url) {
            const patterns = [
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?youtu\.be\/([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/v\/([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/
            ];
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) return match[1];
            }
            return null;
        }

        async function apiRequest(endpoint, options = {}) {
            const url = API_BASE_URL + endpoint;
            const headers = { 'Content-Type': 'application/json', ...options.headers };

            if (adminToken) {
                headers['Authorization'] = `Bearer ${adminToken}`;
            }

            try {
                const response = await fetch(url, { ...options, headers });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erreur serveur');
                }

                return data;
            } catch (err) {
                console.error('API Error:', err);
                throw err;
            }
        }

        // ============================================
        // CHARGEMENT DES DONNÉES
        // ============================================

        async function loadVideos() {
            gridLoader.classList.remove('hidden');
            videoGrid.innerHTML = '';

            try {
                const params = new URLSearchParams();
                if (searchInput.value) params.set('search', searchInput.value);
                if (keywordFilter.value) params.set('keyword', keywordFilter.value);
                if (themeFilter.value) params.set('theme', themeFilter.value);

                const queryString = params.toString() ? '?' + params.toString() : '';
                currentVideos = await apiRequest('/api/videos' + queryString);

                displayVideos(currentVideos);
            } catch (err) {
                videoGrid.innerHTML = `<p class="col-span-full text-center text-red-500">
                    <i class="fas fa-exclamation-circle mr-2"></i>Erreur de chargement: ${err.message}
                </p>`;
                showToast('Erreur de chargement des vidéos', 'error');
            } finally {
                gridLoader.classList.add('hidden');
            }
        }

        async function loadThemes() {
            try {
                themes = await apiRequest('/api/themes');

                // Mettre à jour le filtre de thèmes
                themeFilter.innerHTML = '<option value="">Tous les thèmes</option>';
                themes.forEach(theme => {
                    themeFilter.innerHTML += `<option value="${theme.id}">${theme.name}</option>`;
                });

                // Mettre à jour le select du modal
                const previewTheme = document.getElementById('previewTheme');
                previewTheme.innerHTML = '<option value="">-- Sélectionner --</option>';
                themes.forEach(theme => {
                    previewTheme.innerHTML += `<option value="${theme.id}">${theme.name}</option>`;
                });
            } catch (err) {
                console.error('Erreur chargement thèmes:', err);
            }
        }

        async function loadKeywords() {
            try {
                const keywords = await apiRequest('/api/keywords');

                keywordFilter.innerHTML = '<option value="">Tous les mots-clés</option>';
                keywords.forEach(kw => {
                    keywordFilter.innerHTML += `<option value="${kw}">${kw}</option>`;
                });
            } catch (err) {
                console.error('Erreur chargement mots-clés:', err);
            }
        }

        // ============================================
        // AFFICHAGE DES VIDÉOS
        // ============================================

        function displayVideos(videosToDisplay) {
            videoGrid.innerHTML = '';
            const videosToShow = showingAllVideos ? videosToDisplay : videosToDisplay.slice(0, initialDisplayCount);

            videoCountElem.textContent = `${videosToDisplay.length} vidéo${videosToDisplay.length > 1 ? 's' : ''}`;

            if (videosToShow.length === 0) {
                videoGrid.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8"><i class="fas fa-video-slash mr-2"></i>Aucune vidéo ne correspond à vos critères.</p>';
                viewMoreButton.classList.add('hidden');
                return;
            }

            videosToShow.forEach(video => {
                const card = document.createElement('div');
                card.className = 'video-card rounded-lg shadow-lg overflow-hidden flex flex-col';

                const thumbnailUrl = video.thumbnailUrl ||
                    `https://img.youtube.com/vi/${video.youtubeVideoId}/hqdefault.jpg`;

                const keywordsHtml = (video.keywords || []).slice(0, 4).map(kw =>
                    `<span class="keyword-tag">${kw}</span>`
                ).join('');

                const themeHtml = video.theme ?
                    `<span class="theme-badge" style="background-color: ${video.theme.color}">${video.theme.name}</span>` : '';

                card.innerHTML = `
                    <div class="video-thumbnail-container">
                        ${themeHtml}
                        <img src="${thumbnailUrl}" alt="${video.title}" loading="lazy" onerror="this.src='https://placehold.co/400x225/e0e0e0/999?text=Miniature'">
                    </div>
                    <div class="p-4 flex-grow flex flex-col">
                        <h3 class="font-semibold text-lg mb-1 line-clamp-2" title="${video.title}">${video.title}</h3>
                        <p class="text-gray-600 text-sm mb-2">${video.uploader || 'ISC'} • ${formatViews(video.views)}</p>
                        
                        <p class="text-gray-700 text-sm mb-3 line-clamp-2" title="${video.aiSummary || ''}">
                            ${video.aiSummary || 'Aucun résumé disponible.'}
                        </p>
                        
                        <div class="mb-3 flex flex-wrap">${keywordsHtml}</div>

                        <div class="mt-auto pt-2 flex items-center admin-controls ${isAdmin ? '' : 'hidden'}">
                             <button class="edit-video-btn text-xs text-blue-600 hover:text-blue-800 mr-3" data-id="${video.id}">
                                 <i class="fas fa-edit mr-1"></i>Modifier
                             </button>
                             <button class="delete-video-btn text-xs text-red-600 hover:text-red-800" data-id="${video.id}">
                                 <i class="fas fa-trash mr-1"></i>Supprimer
                             </button>
                        </div>
                    </div>
                `;

                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.edit-video-btn') && !e.target.closest('.delete-video-btn')) {
                        showVideoPlayer(video);
                    }
                });

                if (isAdmin) {
                    card.querySelector('.edit-video-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        openEditVideoModal(video.id);
                    });
                    card.querySelector('.delete-video-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        confirmDeleteVideo(video.id);
                    });
                }

                videoGrid.appendChild(card);
            });

            if (videosToDisplay.length > initialDisplayCount) {
                viewMoreButton.classList.remove('hidden');
                viewMoreButton.textContent = showingAllVideos
                    ? 'Voir Moins'
                    : `Voir Toutes les Vidéos (${videosToDisplay.length})`;
            } else {
                viewMoreButton.classList.add('hidden');
            }
        }

        viewMoreButton.addEventListener('click', () => {
            showingAllVideos = !showingAllVideos;
            displayVideos(currentVideos);
        });

        // ============================================
        // PAGE DE DÉTAIL VIDÉO
        // ============================================

        function showVideoPlayer(video) {
            currentVideoId = video.id;

            videoGridPage.classList.add('hidden');
            videoPlayerPage.classList.remove('hidden');

            if (video.youtubeVideoId) {
                mainVideoPlayerIframe.src = `https://www.youtube.com/embed/${video.youtubeVideoId}?autoplay=1&rel=0`;
            } else {
                mainVideoPlayerIframe.src = '';
            }

            videoTitleElem.textContent = video.title;
            videoUploaderElem.textContent = video.uploader || 'ISC';
            videoViewsElem.textContent = formatViews(video.views);

            if (video.theme) {
                videoThemeElem.textContent = video.theme.name;
                videoThemeElem.style.backgroundColor = video.theme.color;
                videoThemeElem.classList.remove('hidden');
            } else {
                videoThemeElem.classList.add('hidden');
            }

            videoAiSummaryElem.textContent = video.aiSummary || 'Aucun résumé généré disponible.';
            videoAdminAnnotationElem.textContent = video.adminDescription || 'Aucune annotation de l\'administrateur.';
            videoOriginalDescriptionElem.textContent = video.originalDescription || 'Aucune description originale disponible.';

            videoKeywordsContainerElem.innerHTML = '';
            if (video.keywords && video.keywords.length > 0) {
                video.keywords.forEach(kw => {
                    videoKeywordsContainerElem.innerHTML += `<span class="keyword-tag-detail">${kw}</span>`;
                });
            } else {
                videoKeywordsContainerElem.innerHTML = '<p class="text-gray-500">Aucun mot-clé.</p>';
            }

            // Boutons admin
            videoDetailAdminBtns.classList.toggle('hidden', !isAdmin);

            // Mise à jour des boutons de partage
            const pageUrl = window.location.origin + window.location.pathname + '#video=' + video.id;
            const shareTitle = encodeURIComponent(video.title);
            const shareText = encodeURIComponent(`Regardez cette vidéo: ${video.title}`);

            document.getElementById('shareFacebook').href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(pageUrl)}`;
            document.getElementById('shareTwitter').href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(pageUrl)}&text=${shareText}`;
            document.getElementById('shareLinkedIn').href = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(pageUrl)}`;
            document.getElementById('shareWhatsApp').href = `https://wa.me/?text=${shareText}%20${encodeURIComponent(pageUrl)}`;
            document.getElementById('shareTelegram').href = `https://t.me/share/url?url=${encodeURIComponent(pageUrl)}&text=${shareText}`;
            document.getElementById('shareEmail').href = `mailto:?subject=${shareTitle}&body=${shareText}%0A%0A${encodeURIComponent(pageUrl)}`;

            document.getElementById('copyLinkButton').onclick = () => {
                navigator.clipboard.writeText(pageUrl).then(() => {
                    showToast('Lien copié dans le presse-papiers!', 'success');
                }).catch(() => {
                    // Fallback pour navigateurs anciens
                    const tempInput = document.createElement('input');
                    tempInput.value = pageUrl;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    showToast('Lien copié!', 'success');
                });
            };

            window.scrollTo(0, 0);
            window.location.hash = 'video=' + video.id;
        }

        function showHomePage() {
            videoPlayerPage.classList.add('hidden');
            videoGridPage.classList.remove('hidden');
            mainVideoPlayerIframe.src = '';
            currentVideoId = null;
            window.location.hash = '';
        }

        // Boutons admin sur page détail
        document.getElementById('editCurrentVideoBtn').addEventListener('click', () => {
            if (currentVideoId) openEditVideoModal(currentVideoId);
        });

        document.getElementById('deleteCurrentVideoBtn').addEventListener('click', () => {
            if (currentVideoId) confirmDeleteVideo(currentVideoId);
        });

        // ============================================
        // AUTHENTIFICATION ADMIN
        // ============================================

        function checkStoredAuth() {
            const storedToken = localStorage.getItem('isc_admin_token');
            if (storedToken) {
                adminToken = storedToken;
                apiRequest('/api/auth/verify')
                    .then(() => {
                        toggleAdminControls(true);
                    })
                    .catch(() => {
                        localStorage.removeItem('isc_admin_token');
                        adminToken = null;
                    });
            }
        }

        function toggleAdminControls(show) {
            isAdmin = show;
            addYoutubeVideoBtn.classList.toggle('hidden', !show);
            adminLoginButton.innerHTML = show
                ? '<i class="fas fa-sign-out-alt mr-1"></i>Déconnexion'
                : '<i class="fas fa-lock mr-1"></i>Accès Admin';

            // Affiche/cache les contrôles admin sur les cartes
            document.querySelectorAll('.admin-controls').forEach(el => {
                el.classList.toggle('hidden', !show);
            });

            // Affiche/cache les boutons sur la page de détail
            videoDetailAdminBtns.classList.toggle('hidden', !show);
        }

        adminLoginButton.addEventListener('click', () => {
            if (isAdmin) {
                adminToken = null;
                localStorage.removeItem('isc_admin_token');
                toggleAdminControls(false);
                showToast('Déconnecté avec succès', 'info');
            } else {
                showModal(document.getElementById('adminLoginModal'));
            }
        });

        document.getElementById('closeAdminLoginModal').addEventListener('click', () => {
            hideModal(document.getElementById('adminLoginModal'));
        });

        document.getElementById('submitAdminLogin').addEventListener('click', async () => {
            const password = document.getElementById('adminPassword').value;
            if (!password) {
                showToast('Veuillez entrer un mot de passe', 'error');
                return;
            }

            try {
                const response = await apiRequest('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ password })
                });

                adminToken = response.token;
                localStorage.setItem('isc_admin_token', adminToken);
                toggleAdminControls(true);
                hideModal(document.getElementById('adminLoginModal'));
                document.getElementById('adminPassword').value = '';
                showToast('Connecté en tant qu\'administrateur', 'success');

                // Rafraîchir pour afficher les boutons admin
                displayVideos(currentVideos);
            } catch (err) {
                showToast(err.message || 'Mot de passe incorrect', 'error');
            }
        });

        // Permettre la connexion avec Enter
        document.getElementById('adminPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('submitAdminLogin').click();
            }
        });

        // ============================================
        // GESTION DES VIDÉOS (CRUD)
        // ============================================

        // Ouvrir modal d'ajout
        addYoutubeVideoBtn.addEventListener('click', () => {
            document.getElementById('youtubeVideoUrl').value = '';
            document.getElementById('adminCustomDescription').value = '';
            document.getElementById('editingVideoId').value = '';
            document.getElementById('youtubeInfoPreview').classList.add('hidden');
            document.getElementById('previewThumbnail').src = '';
            document.getElementById('previewTitle').value = '';
            document.getElementById('previewChannel').value = '';
            document.getElementById('previewAiSummary').value = '';
            document.getElementById('previewKeywords').value = '';
            document.getElementById('previewTheme').value = '';
            document.getElementById('videoModalTitle').innerHTML = '<i class="fab fa-youtube mr-2"></i>Ajouter une Vidéo YouTube';
            showModal(document.getElementById('addYoutubeVideoModal'));
        });

        document.getElementById('closeAddYoutubeVideoModal').addEventListener('click', () => {
            hideModal(document.getElementById('addYoutubeVideoModal'));
        });

        // Récupérer infos YouTube
        document.getElementById('fetchYoutubeInfoBtn').addEventListener('click', async () => {
            const url = document.getElementById('youtubeVideoUrl').value;
            const videoId = getYouTubeVideoId(url);

            if (!videoId) {
                showToast('URL YouTube invalide', 'error');
                return;
            }

            try {
                const info = await apiRequest(`/api/youtube-info/${videoId}`);

                document.getElementById('previewTitle').value = info.title || '';
                document.getElementById('previewChannel').value = info.channelTitle || '';
                document.getElementById('previewThumbnail').src = info.thumbnail ||
                    `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                document.getElementById('previewAiSummary').value = info.description?.substring(0, 500) || '';
                document.getElementById('previewKeywords').value = (info.tags || []).slice(0, 10).join(', ');

                document.getElementById('youtubeInfoPreview').classList.remove('hidden');
                showToast('Informations récupérées!', 'success');
            } catch (err) {
                // Fallback si l'API ne fonctionne pas
                document.getElementById('previewTitle').value = `Vidéo YouTube`;
                document.getElementById('previewChannel').value = 'Chaîne YouTube';
                document.getElementById('previewThumbnail').src = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                document.getElementById('previewAiSummary').value = '';
                document.getElementById('previewKeywords').value = '';
                document.getElementById('youtubeInfoPreview').classList.remove('hidden');
                showToast('Remplissez les informations manuellement', 'info');
            }
        });

        // Sauvegarder vidéo
        document.getElementById('saveYoutubeVideoBtn').addEventListener('click', async () => {
            const url = document.getElementById('youtubeVideoUrl').value;
            const youtubeVideoId = getYouTubeVideoId(url);
            const editingId = document.getElementById('editingVideoId').value;

            if (!youtubeVideoId) {
                showToast('URL YouTube invalide', 'error');
                return;
            }

            const videoData = {
                youtubeVideoId,
                title: document.getElementById('previewTitle').value || `Vidéo ${youtubeVideoId}`,
                uploader: document.getElementById('previewChannel').value || 'ISC Channel',
                aiSummary: document.getElementById('previewAiSummary').value || '',
                keywords: document.getElementById('previewKeywords').value.split(',').map(kw => kw.trim()).filter(Boolean),
                adminAnnotation: document.getElementById('adminCustomDescription').value || '',
                themeId: document.getElementById('previewTheme').value || null
            };

            try {
                if (editingId) {
                    await apiRequest(`/api/admin/videos/${editingId}`, {
                        method: 'PUT',
                        body: JSON.stringify(videoData)
                    });
                    showToast('Vidéo mise à jour!', 'success');
                } else {
                    await apiRequest('/api/admin/videos', {
                        method: 'POST',
                        body: JSON.stringify(videoData)
                    });
                    showToast('Vidéo ajoutée!', 'success');
                }

                hideModal(document.getElementById('addYoutubeVideoModal'));
                await loadVideos();
                await loadKeywords();
            } catch (err) {
                showToast(err.message || 'Erreur lors de la sauvegarde', 'error');
            }
        });

        // Ouvrir modal d'édition
        function openEditVideoModal(videoId) {
            const video = currentVideos.find(v => v.id === videoId);
            if (!video) return;

            document.getElementById('youtubeVideoUrl').value = `https://www.youtube.com/watch?v=${video.youtubeVideoId}`;
            document.getElementById('adminCustomDescription').value = video.adminDescription || '';
            document.getElementById('editingVideoId').value = video.id;

            document.getElementById('previewTitle').value = video.title;
            document.getElementById('previewChannel').value = video.uploader || '';
            document.getElementById('previewThumbnail').src = video.thumbnailUrl ||
                `https://img.youtube.com/vi/${video.youtubeVideoId}/hqdefault.jpg`;
            document.getElementById('previewAiSummary').value = video.aiSummary || '';
            document.getElementById('previewKeywords').value = (video.keywords || []).join(', ');
            document.getElementById('previewTheme').value = video.theme?.id || '';

            document.getElementById('youtubeInfoPreview').classList.remove('hidden');
            document.getElementById('videoModalTitle').innerHTML = '<i class="fas fa-edit mr-2"></i>Modifier la Vidéo';
            showModal(document.getElementById('addYoutubeVideoModal'));
        }

        // Confirmation de suppression
        let videoToDeleteId = null;

        function confirmDeleteVideo(videoId) {
            videoToDeleteId = videoId;
            showModal(document.getElementById('deleteConfirmModal'));
        }

        document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
            videoToDeleteId = null;
            hideModal(document.getElementById('deleteConfirmModal'));
        });

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!videoToDeleteId) return;

            try {
                await apiRequest(`/api/admin/videos/${videoToDeleteId}`, {
                    method: 'DELETE'
                });

                showToast('Vidéo supprimée!', 'success');
                hideModal(document.getElementById('deleteConfirmModal'));

                // Si on est sur la page de détail, retourner à la grille
                if (currentVideoId === videoToDeleteId) {
                    showHomePage();
                }

                await loadVideos();
                await loadKeywords();
                videoToDeleteId = null;
            } catch (err) {
                showToast(err.message || 'Erreur lors de la suppression', 'error');
            }
        });

        // ============================================
        // FILTRES ET RECHERCHE
        // ============================================

        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(loadVideos, 300); // Debounce
        });

        keywordFilter.addEventListener('change', loadVideos);
        themeFilter.addEventListener('change', loadVideos);

        // ============================================
        // GESTION DE L'URL (DEEP LINKING)
        // ============================================

        function handleUrlHash() {
            const hash = window.location.hash;
            if (hash.startsWith('#video=')) {
                const videoId = hash.replace('#video=', '');
                const video = currentVideos.find(v => v.id === videoId);
                if (video) {
                    showVideoPlayer(video);
                }
            }
        }

        window.addEventListener('hashchange', handleUrlHash);

        // ============================================
        // INITIALISATION
        // ============================================

        document.addEventListener('DOMContentLoaded', async () => {
            checkStoredAuth();
            await loadThemes();
            await loadKeywords();
            await loadVideos();
            handleUrlHash();
        });
    </script>
</body>

</html>