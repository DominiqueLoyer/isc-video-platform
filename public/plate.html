<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plateforme Vid√©o ISC</title>
    <!-- Favicon avec le logo clap -->
    <link rel="icon" href="clap_cine.png" type="image/png">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Arial', sans-serif;
            /* Retour police standard pour match */
            background-color: #f2f5fa;
            color: #222;
            margin: 0;
        }

        /* HEADER STYLE ORIGINAL RESTAUR√â */
        header {
            background: #3740ff;
            /* Bleu UQAM/ISC du code original */
            color: #fff;
            padding: 22px 0;
            text-align: center;
            box-shadow: 0 2px 10px #3740ff22;
        }

        header h1 {
            margin: 0;
            letter-spacing: 0.1em;
            font-size: 2em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .container-custom {
            max-width: 1200px;
            margin: 30px auto 30px;
            background: #fff;
            border-radius: 10px;
            padding: 30px 24px;
            box-shadow: 0 3px 24px #1a227833;
        }

        /* ISC Blue Button Style */
        .btn-isc {
            background-color: #3740ff;
            color: white;
            transition: all 0.2s;
        }

        .btn-isc:hover {
            background-color: #2a30cb;
            transform: translateY(-1px);
        }

        .video-card {
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #edf2f7;
            display: flex;
            flex-direction: column;
        }

        .video-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        .theme-badge {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            color: white;
            opacity: 0.9;
        }

        .keyword-tag {
            font-size: 11px;
            background-color: #eee;
            color: #3740ff;
            padding: 2px 8px;
            border-radius: 4px;
            margin-right: 4px;
            margin-bottom: 4px;
            display: inline-block;
        }

        .share-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
            color: #3740ff;
            /* Couleur ISC */
            background-color: #eef2ff;
        }

        .share-btn:hover {
            background-color: #3740ff;
            color: white;
            transform: scale(1.1);
        }

        /* Modal Styles */
        .modal {
            transition: opacity 0.25s ease;
        }

        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- HEADER (Design Restaur√© avec Logo Clap) -->
    <header>
        <h1>
            <!-- Logo Clap fourni -->
            <img src="clap_cine.png" alt="Logo" width="32" height="32" style="vertical-align: bottom;">
            Plateforme Vid√©o ISC
        </h1>
        <div style="font-size:13px;opacity:0.82;margin-top:5px;">Ajout, gestion et annotation collaborative de vid√©os
            YouTube</div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow container-custom mx-auto px-4 py-8">

        <!-- Controls & Search -->
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
            <!-- Search -->
            <div class="relative w-full md:w-96">
                <input type="text" id="searchInput" placeholder="Rechercher (titre, mot-cl√©, r√©sum√©...)"
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>

            <!-- Filters & Admin -->
            <div class="flex gap-3 w-full md:w-auto">
                <select id="keywordFilter"
                    class="px-4 py-2 border border-gray-300 rounded-lg bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer hidden md:block">
                    <option value="">Tous les mots-cl√©s</option>
                </select>

                <select id="themeFilter"
                    class="px-4 py-2 border border-gray-300 rounded-lg bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer">
                    <option value="">Toutes th√©matiques</option>
                </select>

                <button id="adminBtn"
                    class="flex items-center gap-2 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors shadow-sm">
                    <i class="fas fa-lock"></i> <span class="hidden sm:inline">Admin</span>
                </button>
            </div>
        </div>

        <!-- Video Grid -->
        <div id="videoGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Les vid√©os seront inject√©es ici -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
                <i class="fas fa-film text-gray-400 text-2xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900">Aucune vid√©o trouv√©e</h3>
            <p class="text-gray-500 mt-2">Essayez de modifier vos filtres ou d'ajouter une nouvelle vid√©o.</p>
        </div>

        <!-- Loading State -->
        <div id="gridLoader" class="flex justify-center items-center py-12 hidden">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>

        <!-- Pagination / View More -->
        <div class="text-center mt-8">
            <button id="viewMoreBtn"
                class="hidden px-6 py-2 border border-gray-300 rounded-full text-gray-600 hover:bg-gray-50 transition-colors">
                Voir plus de vid√©os
            </button>
            <p id="videoCount" class="text-sm text-gray-500 mt-2"></p>
        </div>
    </main>

    <!-- FOOTER (Ajust√© en taille) -->
    <div style="text-align:center; margin-top:1em; margin-bottom: 2em; font-size:12px; color:#888;">
        Cr√©ation
        <a href="https://dominiqueloyer.github.io" target="_blank" rel="noopener" title="Cr√©ation Dominique Loyer"
            style="text-decoration:none;">
            <img src="peace.png" alt="Creation Dominique Loyer" width="14" height="14"
                style="vertical-align:middle; margin:0 4px; opacity:0.8; transition:opacity 0.2s;" />
        </a>
        MMXXVI
    </div>

    <!-- MODALS -->

    <!-- Admin Login Modal -->
    <div id="loginModal"
        class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div
            class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto transform transition-all scale-95">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-xl font-bold text-gray-800">üîí Acc√®s Administrateur</p>
                    <div class="modal-close cursor-pointer z-50 p-2 hover:bg-gray-100 rounded-full">
                        <i class="fas fa-times text-gray-500"></i>
                    </div>
                </div>
                <form id="loginForm" class="my-5">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Mot de passe</label>
                        <input type="password" id="adminPassword"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="flex justify-end pt-2">
                        <button type="submit" class="btn-isc px-4 py-2 rounded-lg font-medium shadow-md">
                            Se connecter
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add/Edit Video Modal -->
    <div id="videoModal"
        class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div
            class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto max-h-[90vh] transform transition-all scale-95">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-xl font-bold text-gray-800" id="modalTitle">Ajouter une vid√©o</p>
                    <div class="modal-close cursor-pointer z-50 p-2 hover:bg-gray-100 rounded-full">
                        <i class="fas fa-times text-gray-500"></i>
                    </div>
                </div>

                <form id="videoForm" class="my-5 space-y-4">
                    <input type="hidden" id="editVideoId">

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">URL YouTube</label>
                        <div class="flex gap-2">
                            <input type="text" id="videoUrlInput"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="https://youtube.com/watch?v=...">
                            <button type="button" id="fetchInfoBtn"
                                class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded shadow-sm whitespace-nowrap transition-colors">
                                <i class="fas fa-magic mr-1 text-purple-600"></i> R√©cup√©rer Infos
                            </button>
                        </div>
                        <p id="fetchStatus" class="text-xs mt-1 h-4"></p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Titre</label>
                            <input type="text" id="videoTitleInput" required
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Cha√Æne / Auteur</label>
                            <input type="text" id="videoUploaderInput"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Th√©matique</label>
                        <select id="videoThemeSelect"
                            class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                            <!-- Rempli par JS -->
                        </select>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            R√©sum√© IA
                            <span class="text-xs font-normal text-gray-500 ml-2">(G√©n√©r√© automatiquement ou
                                √©ditable)</span>
                        </label>
                        <textarea id="videoSummaryInput" rows="3"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Mots-cl√©s (Bilingues)</label>
                        <input type="text" id="videoKeywordsInput" placeholder="S√©parez par des virgules"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2 text-yellow-700">Annotation Admin
                            (Optionnel)</label>
                        <textarea id="adminAnnotationInput" rows="2"
                            class="shadow appearance-none border border-yellow-200 bg-yellow-50 rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-yellow-500"
                            placeholder="Note interne visible sur la fiche..."></textarea>
                    </div>

                    <!-- Hidden fields for metadata -->
                    <input type="hidden" id="videoDescriptionHidden">
                    <input type="hidden" id="videoYoutubeIdHidden">

                    <div class="flex justify-end pt-4 border-t gap-3">
                        <button type="button"
                            class="modal-close px-4 py-2 bg-transparent p-3 rounded-lg text-gray-500 hover:bg-gray-100 hover:text-gray-700 mr-2">
                            Annuler
                        </button>
                        <button type="submit" id="saveVideoBtn"
                            class="btn-isc px-6 py-2 rounded-lg font-medium shadow-md flex items-center gap-2">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- PLAYER OVERLAY (Pour la lecture et le partage) -->
    <div id="playerOverlay"
        class="fixed inset-0 z-[60] bg-black bg-opacity-90 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto flex flex-col relative">
            <button id="closePlayer"
                class="absolute top-4 right-4 z-10 bg-black bg-opacity-50 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-opacity-80 transition-all">
                <i class="fas fa-times"></i>
            </button>

            <div class="aspect-video w-full bg-black">
                <iframe id="playerFrame" class="w-full h-full" frameborder="0" allow="autoplay; encrypted-media"
                    allowfullscreen></iframe>
            </div>

            <div class="p-6">
                <!-- Share Buttons Row -->
                <div class="flex flex-wrap gap-2 mb-6 p-4 bg-blue-50 rounded-xl justify-center">
                    <button class="share-btn" onclick="share('linkedin')" title="LinkedIn"><i
                            class="fab fa-linkedin-in"></i></button>
                    <button class="share-btn" onclick="share('twitter')" title="X (Twitter)"><i
                            class="fab fa-x-twitter"></i></button>
                    <button class="share-btn" onclick="share('bluesky')" title="Bluesky"><i
                            class="fas fa-cloud"></i></button>
                    <button class="share-btn" onclick="share('reddit')" title="Reddit"><i
                            class="fab fa-reddit-alien"></i></button>
                    <button class="share-btn" onclick="share('facebook')" title="Facebook"><i
                            class="fab fa-facebook-f"></i></button>
                    <button class="share-btn" onclick="share('discord')" title="Discord"><i
                            class="fab fa-discord"></i></button>
                    <div class="w-px h-6 bg-blue-200 mx-1"></div>
                    <button class="share-btn" onclick="share('obsidian')" title="Obsidian"><i
                            class="fas fa-gem"></i></button>
                    <button class="share-btn" onclick="share('notion')" title="Notion"><i
                            class="fas fa-cube"></i></button>
                    <button class="share-btn" onclick="share('email')" title="Email"><i
                            class="fas fa-envelope"></i></button>
                    <button class="share-btn" onclick="share('copy')" title="Copier le lien"><i
                            class="fas fa-link"></i></button>
                </div>

                <h2 id="playerTitle" class="text-2xl font-bold mb-2"></h2>
                <div class="flex items-center gap-4 text-sm text-gray-600 mb-4">
                    <span id="playerUploader" class="font-medium text-gray-900"></span>
                    <span>‚Ä¢</span>
                    <span id="playerViews"></span> vues
                    <span id="playerTheme" class="theme-badge ml-auto"></span>
                </div>

                <div id="playerKeywords" class="mb-4"></div>

                <div id="playerSummary"
                    class="bg-gray-50 p-4 rounded-lg text-gray-700 italic border-l-4 border-blue-500 mb-4 text-sm">
                </div>

                <div id="playerAdminNote"
                    class="hidden bg-yellow-50 p-3 rounded border border-yellow-200 text-yellow-800 text-sm mb-4">
                    <i class="fas fa-sticky-note mr-2"></i> <span id="playerAdminNoteText"></span>
                </div>

                <div class="mt-4 border-t pt-4">
                    <p id="playerDescription" class="text-gray-600 text-sm whitespace-pre-wrap"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast"
        class="fixed bottom-5 right-5 transform translate-y-20 opacity-0 transition-all duration-300 z-[100] px-6 py-3 rounded-lg shadow-lg text-white font-medium flex items-center gap-3">
        <i class="fas fa-info-circle"></i>
        <span id="toastMessage">Notification</span>
    </div>

    <script>
        // CONFIG
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000'
            : ''; // En prod (Render), URL relative

        // STATE
        let adminToken = localStorage.getItem('isc_admin_token');
        let currentVideos = [];
        let themes = [];
        let showingAllVideos = false;
        const initialDisplayCount = 9;

        // ELEMENTS
        const videoGrid = document.getElementById('videoGrid');
        const searchInput = document.getElementById('searchInput');
        const themeFilter = document.getElementById('themeFilter');
        const keywordFilter = document.getElementById('keywordFilter');
        const adminBtn = document.getElementById('adminBtn');
        const loginModal = document.getElementById('loginModal');
        const videoModal = document.getElementById('videoModal');
        const emptyState = document.getElementById('emptyState');
        const gridLoader = document.getElementById('gridLoader');
        const viewMoreButton = document.getElementById('viewMoreBtn');
        const videoCountElem = document.getElementById('videoCount');

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            loadThemes();
            loadKeywords();
            loadVideos();
            checkAdminStatus();
            setupEventListeners();
        });

        // API UTILS
        async function apiRequest(endpoint, options = {}) {
            const url = API_BASE_URL + endpoint;
            const headers = { 'Content-Type': 'application/json', ...options.headers };

            if (adminToken) {
                headers['Authorization'] = `Bearer ${adminToken}`;
            }

            try {
                const response = await fetch(url, { ...options, headers });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erreur serveur');
                }

                return data;
            } catch (err) {
                console.error('API Error:', err);
                throw err;
            }
        }

        // LOAD DATA
        async function loadThemes() {
            try {
                themes = await apiRequest('/api/themes');
                const select = document.getElementById('themeFilter');
                const modalSelect = document.getElementById('videoThemeSelect');

                const options = themes.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                select.innerHTML = `<option value="">Toutes th√©matiques</option>${options}`;
                modalSelect.innerHTML = `<option value="">Choisir une th√©matique...</option>${options}`;
            } catch (err) {
                console.error('Erreur chargement th√®mes', err);
            }
        }

        async function loadKeywords() {
            try {
                const keywords = await apiRequest('/api/keywords');
                const select = document.getElementById('keywordFilter');
                select.innerHTML = `<option value="">Tous les mots-cl√©s</option>` +
                    keywords.map(k => `<option value="${k}">${k}</option>`).join('');
            } catch (err) {
                console.warn('Erreur chargement mots-cl√©s', err);
            }
        }

        async function loadVideos() {
            gridLoader.classList.remove('hidden');
            videoGrid.innerHTML = '';

            try {
                const params = new URLSearchParams();
                if (searchInput.value) params.set('search', searchInput.value);
                if (keywordFilter.value) params.set('keyword', keywordFilter.value);
                if (themeFilter.value) params.set('theme', themeFilter.value);

                const queryString = params.toString() ? '?' + params.toString() : '';
                currentVideos = await apiRequest('/api/videos' + queryString);

                displayVideos(currentVideos);
            } catch (err) {
                videoGrid.innerHTML = `<p class="col-span-full text-center text-red-500">
                    <i class="fas fa-exclamation-circle mr-2"></i>Erreur de chargement: ${err.message}
                </p>`;
                showToast('Erreur de chargement des vid√©os', 'error');
            } finally {
                gridLoader.classList.add('hidden');
            }
        }

        function displayVideos(videosToDisplay) {
            videoGrid.innerHTML = '';
            const videosToShow = showingAllVideos ? videosToDisplay : videosToDisplay.slice(0, initialDisplayCount);

            videoCountElem.textContent = `${videosToDisplay.length} vid√©o${videosToDisplay.length > 1 ? 's' : ''}`;

            if (videosToShow.length === 0) {
                emptyState.classList.remove('hidden');
                viewMoreButton.classList.add('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            videosToShow.forEach(video => {
                const card = document.createElement('div');
                card.className = 'video-card bg-white rounded-lg shadow-sm overflow-hidden flex flex-col h-full cursor-pointer hover:shadow-md transition-all duration-200 group';

                const thumbnailUrl = video.thumbnailUrl ||
                    `https://img.youtube.com/vi/${video.youtubeVideoId}/hqdefault.jpg`;

                // Mots-cl√©s limit√©s √† 4
                const keywordsHtml = (video.keywords || []).slice(0, 4).map(kw =>
                    `<span class="keyword-tag">${kw}</span>`
                ).join('');

                const themeHtml = video.theme ?
                    `<span class="theme-badge" style="background-color: ${video.theme.color}">${video.theme.name}</span>` : '';

                card.innerHTML = `
                    <div class="relative aspect-video bg-gray-100 overflow-hidden">
                        <img src="${thumbnailUrl}" alt="${video.title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                        <div class="absolute top-2 right-2">${themeHtml}</div>
                        <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-300">
                            <i class="fas fa-play-circle text-white text-5xl opacity-0 group-hover:opacity-90 transform scale-50 group-hover:scale-100 transition-all duration-300"></i>
                        </div>
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="font-bold text-gray-800 line-clamp-2 mb-1 group-hover:text-blue-600 transition-colors">${video.title}</h3>
                        <div class="text-xs text-gray-500 mb-3 flex items-center gap-2">
                             <span><i class="fas fa-user-circle"></i> ${video.uploader}</span>
                             <span>‚Ä¢</span>
                             <span><i class="fas fa-eye"></i> ${video.views}</span>
                        </div>
                        
                        <div class="mb-3 flex flex-wrap gap-1">
                            ${keywordsHtml}
                        </div>

                        ${video.aiSummary ? `<p class="text-xs text-gray-500 line-clamp-2 italic mb-3">"${video.aiSummary}"</p>` : ''}
                        
                        <div class="mt-auto pt-3 border-t border-gray-100 flex justify-between items-center">
                            <span class="text-xs font-semibold text-blue-600">Voir la vid√©o</span>
                            ${adminToken ? `
                            <div class="flex gap-2">
                                <button onclick="editVideo('${video.id}', event)" class="p-1.5 text-gray-400 hover:text-blue-600 rounded hover:bg-blue-50 transition-colors" title="Modifier">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button onclick="deleteVideo('${video.id}', event)" class="p-1.5 text-gray-400 hover:text-red-600 rounded hover:bg-red-50 transition-colors" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>` : ''}
                        </div>
                    </div>
                `;

                // Clic sur la carte ouvre le player
                card.onclick = (e) => {
                    // Ignorer si clic sur boutons admin
                    if (!e.target.closest('button')) {
                        openPlayer(video);
                    }
                };

                videoGrid.appendChild(card);
            });

            if (videosToDisplay.length > initialDisplayCount && !showingAllVideos) {
                viewMoreButton.classList.remove('hidden');
            } else {
                viewMoreButton.classList.add('hidden');
            }
        }

        // PLAYER LOGIC
        function openPlayer(video) {
            const player = document.getElementById('playerOverlay');
            document.getElementById('playerFrame').src = `https://www.youtube.com/embed/${video.youtubeVideoId}?autoplay=1`;
            document.getElementById('playerTitle').textContent = video.title;
            document.getElementById('playerUploader').textContent = video.uploader;
            document.getElementById('playerViews').textContent = video.views.toLocaleString();
            document.getElementById('playerDescription').textContent = video.originalDescription;
            document.getElementById('playerTheme').textContent = video.theme?.name || '';
            document.getElementById('playerTheme').style.backgroundColor = video.theme?.color || '#999';

            document.getElementById('playerSummary').textContent = video.aiSummary || "Pas de r√©sum√© disponible.";

            const kwContainer = document.getElementById('playerKeywords');
            kwContainer.innerHTML = (video.keywords || []).map(k => `<span class="keyword-tag text-sm py-1 px-3">${k}</span>`).join('');

            const noteElem = document.getElementById('playerAdminNote');
            if (video.adminDescription) {
                noteElem.classList.remove('hidden');
                document.getElementById('playerAdminNoteText').textContent = video.adminDescription;
            } else {
                noteElem.classList.add('hidden');
            }

            // Stocker l'URL actuelle pour le partage
            window.currentVideoUrl = `https://www.youtube.com/watch?v=${video.youtubeVideoId}`;
            window.currentVideoTitle = video.title;

            player.classList.remove('hidden');
        }

        document.getElementById('closePlayer').onclick = () => {
            document.getElementById('playerOverlay').classList.add('hidden');
            document.getElementById('playerFrame').src = '';
        };

        // ADMIN LOGIC
        function checkAdminStatus() {
            if (adminToken) {
                adminBtn.innerHTML = `<i class="fas fa-plus-circle"></i> <span class="hidden sm:inline">Ajouter</span>`;
                adminBtn.classList.replace('bg-gray-800', 'btn-isc');
                adminBtn.onclick = openAddModal;
            } else {
                adminBtn.innerHTML = `<i class="fas fa-lock"></i> <span class="hidden sm:inline">Admin</span>`;
                adminBtn.classList.replace('btn-isc', 'bg-gray-800');
                adminBtn.onclick = () => toggleModal(loginModal);
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            document.getElementById('loginForm').onsubmit = async (e) => {
                e.preventDefault();
                const password = document.getElementById('adminPassword').value;

                try {
                    const data = await apiRequest('/api/auth/login', {
                        method: 'POST',
                        body: JSON.stringify({ password })
                    });

                    adminToken = data.token;
                    localStorage.setItem('isc_admin_token', adminToken);
                    showToast('Connexion r√©ussie', 'success');
                    toggleModal(loginModal);
                    checkAdminStatus();
                    loadVideos(); // Recharger pour afficher les boutons admin
                } catch (err) {
                    showToast(err.message, 'error');
                }
            };

            // ADD/EDIT VIDEO
            document.getElementById('fetchInfoBtn').onclick = async () => {
                const url = document.getElementById('videoUrlInput').value;
                const statusFn = document.getElementById('fetchStatus');

                // Extraire ID
                let videoId = '';
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                const match = url.match(regExp);
                if (match && match[2].length === 11) {
                    videoId = match[2];
                } else {
                    showToast('URL YouTube invalide', 'error');
                    return;
                }

                document.getElementById('videoYoutubeIdHidden').value = videoId;
                statusFn.textContent = '‚è≥ R√©cup√©ration YouTube...';
                statusFn.className = 'text-xs mt-1 text-blue-600 animate-pulse';

                try {
                    // 1. YouTube API
                    const ytData = await apiRequest(`/api/youtube-info/${videoId}`);

                    document.getElementById('videoTitleInput').value = ytData.title;
                    document.getElementById('videoUploaderInput').value = ytData.channelTitle;
                    document.getElementById('videoDescriptionHidden').value = ytData.description;

                    statusFn.textContent = 'ü§ñ G√©n√©ration R√©sum√© IA...';

                    // 2. Gemini API
                    const summaryData = await apiRequest('/api/generate-summary', {
                        method: 'POST',
                        body: JSON.stringify({
                            title: ytData.title,
                            description: ytData.description,
                            channelTitle: ytData.channelTitle
                        })
                    });

                    document.getElementById('videoSummaryInput').value = summaryData.summary;

                    // Mots-cl√©s bilingues
                    if (summaryData.keywords && Array.isArray(summaryData.keywords)) {
                        document.getElementById('videoKeywordsInput').value = summaryData.keywords.join(', ');
                    }

                    statusFn.textContent = '‚úÖ Infos r√©cup√©r√©es avec succ√®s !';
                    statusFn.className = 'text-xs mt-1 text-green-600';

                } catch (err) {
                    statusFn.textContent = '‚ùå Erreur: ' + err.message;
                    statusFn.className = 'text-xs mt-1 text-red-600';
                }
            };

            // SAVE VIDEO
            document.getElementById('videoForm').onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById('editVideoId').value;
                const isEdit = !!id;

                const payload = {
                    youtubeVideoId: document.getElementById('videoYoutubeIdHidden').value,
                    title: document.getElementById('videoTitleInput').value,
                    uploader: document.getElementById('videoUploaderInput').value,
                    themeId: document.getElementById('videoThemeSelect').value || null,
                    aiSummary: document.getElementById('videoSummaryInput').value,
                    keywords: document.getElementById('videoKeywordsInput').value.split(',').map(s => s.trim()).filter(s => s),
                    adminAnnotation: document.getElementById('adminAnnotationInput').value,
                    originalDescription: document.getElementById('videoDescriptionHidden').value
                };

                try {
                    await apiRequest(isEdit ? `/api/admin/videos/${id}` : '/api/admin/videos', {
                        method: isEdit ? 'PUT' : 'POST',
                        body: JSON.stringify(payload)
                    });

                    showToast(isEdit ? 'Vid√©o modifi√©e' : 'Vid√©o ajout√©e', 'success');
                    toggleModal(videoModal);
                    loadVideos();
                    loadKeywords(); // Update keywords list
                } catch (err) {
                    showToast(err.message, 'error');
                }
            };

            // MODAL UTILS
            function toggleModal(modal) {
                modal.classList.toggle('opacity-0');
                modal.classList.toggle('pointer-events-none');
                document.body.classList.toggle('modal-active');
            }

            document.querySelectorAll('.modal-overlay, .modal-close').forEach(el => {
                el.onclick = (e) => {
                    const modal = e.target.closest('.modal');
                    if (modal) toggleModal(modal);
                };
            });

            // SHARING LOGIC
            window.share = (platform) => {
                const url = encodeURIComponent(window.currentVideoUrl);
                const title = encodeURIComponent(window.currentVideoTitle);
                let shareUrl = '';

                switch (platform) {
                    case 'linkedin': shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`; break;
                    case 'twitter': shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${title}`; break;
                    case 'bluesky': shareUrl = `https://bsky.app/intent/compose?text=${title}%20${url}`; break;
                    case 'reddit': shareUrl = `https://www.reddit.com/submit?url=${url}&title=${title}`; break;
                    case 'facebook': shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`; break;
                    case 'discord': navigator.clipboard.writeText(window.currentVideoUrl).then(() => showToast('Lien copi√© pour Discord !', 'success')); return;
                    case 'obsidian': shareUrl = `obsidian://new?name=${title}&content=${url}`; break;
                    case 'notion': shareUrl = `https://www.notion.so/`; break; // Pas de deep link simple, ouverture homepage
                    case 'email': shareUrl = `mailto:?subject=${title}&body=${url}`; break;
                    case 'copy':
                        navigator.clipboard.writeText(window.currentVideoUrl).then(() => showToast('Lien copi√© !', 'success'));
                        return;
                }

                if (shareUrl) window.open(shareUrl, '_blank', 'width=600,height=400');
            };

            // Listeners
            searchInput.oninput = loadVideos;
            themeFilter.onchange = loadVideos;
            keywordFilter.onchange = loadVideos;
            viewMoreButton.onclick = () => {
                showingAllVideos = true;
                displayVideos(currentVideos);
            }

            // Edit modal open
            window.openAddModal = () => {
                document.getElementById('modalTitle').textContent = 'Ajouter une vid√©o';
                document.getElementById('videoForm').reset();
                document.getElementById('editVideoId').value = '';
                document.getElementById('fetchStatus').textContent = '';
                toggleModal(videoModal);
            }
        }

        // DELETE VIDEO
        window.deleteVideo = async (id, e) => {
            e.stopPropagation();
            if (!confirm('Voulez-vous vraiment supprimer cette vid√©o ?')) return;

            try {
                await apiRequest(`/api/admin/videos/${id}`, { method: 'DELETE' });
                showToast('Vid√©o supprim√©e', 'success');
                loadVideos();
            } catch (err) {
                showToast(err.message, 'error');
            }
        };

        // EDIT VIDEO BUTTON
        window.editVideo = async (id, e) => {
            e.stopPropagation();
            try {
                const video = currentVideos.find(v => v.id === id);
                if (!video) return;

                document.getElementById('modalTitle').textContent = 'Modifier la vid√©o';
                document.getElementById('editVideoId').value = video.id;
                document.getElementById('videoYoutubeIdHidden').value = video.youtubeVideoId;
                document.getElementById('videoUrlInput').value = `https://youtu.be/${video.youtubeVideoId}`;
                document.getElementById('videoTitleInput').value = video.title;
                document.getElementById('videoUploaderInput').value = video.uploader;
                document.getElementById('videoThemeSelect').value = video.theme?.id || '';
                document.getElementById('videoSummaryInput').value = video.aiSummary;
                document.getElementById('videoKeywordsInput').value = video.keywords.join(', ');
                document.getElementById('adminAnnotationInput').value = video.adminDescription || '';
                document.getElementById('videoDescriptionHidden').value = video.originalDescription;
                document.getElementById('fetchStatus').textContent = '';

                toggleModal(videoModal);
            } catch (err) {
                console.error(err);
            }
        };

        // TOAST UTILS
        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('i');
            document.getElementById('toastMessage').textContent = msg;

            toast.className = 'fixed bottom-5 right-5 transform translate-y-0 opacity-100 transition-all duration-300 z-[100] px-6 py-3 rounded-lg shadow-lg text-white font-medium flex items-center gap-3';

            if (type === 'success') {
                toast.classList.add('bg-green-600');
                icon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                toast.classList.add('bg-red-600');
                icon.className = 'fas fa-exclamation-circle';
            } else {
                toast.classList.add('bg-blue-600');
                icon.className = 'fas fa-info-circle';
            }

            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

    </script>
</body>

</html>